name: Cleanup PR Preview

on:
  pull_request:
    types:
      - closed  # Kj√∏rer n√•r PR lukkes (merge eller close)

jobs:
  cleanup:
    name: Delete PR Preview
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'
      pull-requests: write
    steps:
      - uses: actions/checkout@v5

      - name: Login to NAIS
        uses: nais/login@v0
        id: login
        with:
          team: teamdagpenger
          identity_provider: ${{ secrets.NAIS_WORKLOAD_IDENTITY_PROVIDER }}
          project_id: ${{ vars.NAIS_MANAGEMENT_PROJECT_ID }}

      - name: Set up kubectl credentials
        uses: google-github-actions/get-gke-credentials@v3
        with:
          cluster_name: dev-gcp
          location: europe-north1

      - name: Delete NAIS application
        run: |
          kubectl delete app dp-rapportering-saksbehandling-frontend-pr-${{ github.event.pull_request.number }} \
            -n teamdagpenger \
            --ignore-not-found=true

      - name: Comment on PR
        if: always()
        uses: actions/github-script@v8
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const appName = `dp-rapportering-saksbehandling-frontend-pr-${prNumber}`;
            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `üßπ **Preview cleanup**\n\nPR preview app \`${appName}\` har blitt slettet fra NAIS.`
            })
